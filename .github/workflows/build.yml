name: Build and Release PowerBrightnessSync

on:
  push:
    tags:
      - 'v*.*.*'
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build Windows Executable
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Create build directory
      run: mkdir build

    - name: Compile PowerBrightnessSync
      shell: powershell
      run: |
        cl /nologo /W4 /EHsc /std:c++17 /O1 /Os /Gy /MT /GS- /GL /DNDEBUG /DUNICODE /D_UNICODE /D_WIN32_WINNT=0x0601 `
        PowerBrightnessSync.cpp `
        ole32.lib oleaut32.lib `
        /link /LTCG /SUBSYSTEM:WINDOWS /ENTRY:wWinMainCRTStartup /OPT:REF /OPT:ICF `
        /MANIFEST:EMBED /MANIFESTUAC:"level='requireAdministrator' uiAccess='false'" `
        /OUT:build\PowerBrightnessSync.exe

    - name: Verify Build
      shell: powershell
      run: |
        if (Test-Path build\PowerBrightnessSync.exe) {
            Write-Host "Build Successful"
        } else {
            Write-Error "Build Failed"
            exit 1
        }

    - name: Zip executable
      shell: powershell
      run: |
        Compress-Archive -Path build\PowerBrightnessSync.exe -DestinationPath build\PowerBrightnessSync.zip

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: PowerBrightnessSync-Build
        path: build/PowerBrightnessSync.exe
        if-no-files-found: error

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: |
          build/PowerBrightnessSync.exe
          build/PowerBrightnessSync.zip
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}